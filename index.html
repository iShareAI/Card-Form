<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Card Builder · 360° + Options</title>
<style>
  :root{ --radius:16px; --muted:#6b7280; --border:#e5e7eb; --primary:#635bff; }
  html,body{margin:0;padding:0;background:#fff;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}






  /* Builder (form) */
  .builder{padding:16px;border:1px solid var(--border);border-radius:12px}
  .builder h3{margin:0 0 10px;font-size:18px}
  .builder label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
  .row-inline{display:flex;align-items:center;gap:8px}
  .builder input,.builder select,.builder textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font:inherit}
  .builder textarea{min-height:96px}
  .builder-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#111827}
  .note{font-size:12px;color:var(--muted)}

  /* не растягивать чекбоксы и убрать рамку/паддинги от общего правила */
.builder input[type="checkbox"]{
  width:auto;
  height:auto;
  padding:0;
  border:0;
  border-radius:0;
}

/* выравнивание лейбл + подсказка + чекбокс в один ряд */
.inline-control{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:10px;
  flex-wrap:nowrap;
}
.inline-control .label-line{
  margin:0;
  flex:1 1 auto;
  min-width:0;
}
.inline-control input[type="checkbox"]{
  flex:0 0 auto;
  width:18px;   /* под увеличить кликабельность */
  height:18px;
}


  .actions{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center; }
.actions .btn{ flex:0 0 auto; }

/* optional: mini button style (e.g., for "New ID") */
.btn--mini{ padding:4px 8px; font-size:12px; }

/* mobile-friendly sticky actions inside the .builder column */
@media (max-width: 900px){
  .actions{
    position: sticky;
    bottom: 0;
    left: 0;
    padding: 12px 0;
    background: #fff;
    border-top: 1px solid var(--border);
    z-index: 5;
  }
  /* make the primary button expand, keep the rest compact */
  #launch.btn{ flex: 1 1 auto; }
  .actions .btn.secondary{ flex: 0 0 auto; }
}


  /* Dropzone */
/* --- Upload section (polished) --- */
.dropzone{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:12px;
  align-items:center;
  margin-top:10px;
  border:1.5px dashed var(--border);
  border-radius:12px;
  padding:12px;
  background:#fafafa;
  cursor:pointer;
}
.dropzone.over{ background:#eef2ff; border-color:#c7d2fe; }

.dz-left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
.dz-text{ font-size:12px; color:var(--muted); }
.dz-hint{ font-size:11px; color:#9ca3af; }
.dz-meta{ font-size:12px; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.dz-error{ font-size:12px; color:#b91c1c; }

.dz-actions{ display:flex; align-items:center; }
.dz-btn{
  background:#111827; color:#fff; border:0; border-radius:8px;
  padding:8px 12px; font-size:12px; cursor:pointer;
}

/* Photo mode inside media (no distortion) */
.media img.photo{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:cover; display:block;
}

/* Small ID line on card */
.small--id{ font-size:11px; color:#9ca3af; margin-top:4px; }

  

  /* Card (твой стиль) */
  .card{width:260px}
  .media{aspect-ratio:9/16;width:100%;border-radius:var(--radius);overflow:hidden;background:#eef1f5;margin-bottom:10px;position:relative;cursor:grab}
  .media.dragging{cursor:grabbing}
  .media canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
  .loader{position:absolute;inset:0;display:grid;place-items:center;color:#6b7280;font-size:12px;background:linear-gradient(180deg,#f6f7f9 0%, #eef0f3 100%)}
  .loader.hidden{display:none}

  .title{font-weight:600;line-height:1.3;margin:0 0 6px;font-size:15px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 8px}
  .chip{font-size:12px;line-height:18px;padding:2px 8px;border-radius:9999px;background:#f3f4f6}
  .chip.health{background:#eef2ff;color:#3b82f6}
  .chip.tax{background:#ecfdf5;color:#047857}
  .chip.match{background:#fff7ed;color:#b45309}/* AI chip (same size as other chips) */
.chip.ai{
  background:#f5f3ff;   /* soft violet */
  color:#7c3aed;        /* violet text */
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.chip.ai .ico{
  font-size:12px;       /* emoji/icon size */
  line-height:1;
}


  .bar{height:6px;background:#f3f4f6;border-radius:9999px}
  .bar>i{display:block;height:100%;width:0;background:var(--primary);border-radius:9999px}

  .row{display:flex;align-items:center;justify-content:space-between;margin-top:4px}
  .row.stats{position:relative}
  .small{font-size:12px;color:#6b7280;margin-top:2px}

  .accent{color:#2563eb;font-size:13px;margin-top:6px;margin-bottom:2px}
  .tiers{position:relative;margin-top:2px}
  .tier-link{background:none;border:0;padding:0;font:inherit;cursor:pointer;color:#2563eb;text-decoration:none;display:inline-flex;align-items:center;gap:6px;font-size:13px}
  .tier-link:hover{text-decoration:underline}
  .tier-link::after{content:"▾";font-size:10px;transform:translateY(1px);transition:.2s}
  .tier-link[aria-expanded="true"]::after{transform:translateY(1px) rotate(180deg)}
  .tier-menu{position:absolute;left:0;right:0;top:100%;margin-top:4px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,.14);overflow:hidden;z-index:10}
  .tier-row{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;font-size:13px}
  .tier-row+.tier-row{border-top:1px solid #f3f4f6}

  /* Tooltip (stats) */
  .raised{cursor:help;border-bottom:1px dotted rgba(99,91,255,.35)}
  .tooltip{position:absolute;left:0;top:100%;margin-top:8px;z-index:20;width:220px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.14);padding:10px;display:none}
  .tooltip.open{display:block;animation:pop .12s ease-out}
  @keyframes pop{from{transform:translateY(4px);opacity:.7}to{transform:none;opacity:1}}
  .tooltip::before{content:"";position:absolute;top:-6px;left:16px;width:10px;height:10px;background:#fff;border-left:1px solid var(--border);border-top:1px solid var(--border);transform:rotate(45deg)}
  .spark{width:100%}.line{fill:none;stroke:var(--primary);stroke-width:2}.area{fill:rgba(99,91,255,.12)}.grid{stroke:#f3f4f6;stroke-width:1}
  /* Spark + animation */
.spark{ width:100%; height:auto; display:block; }
.spark .grid{ stroke:#f3f4f6; stroke-width:1; }
.spark .line{ fill:none; stroke:var(--primary); stroke-width:2; stroke-linecap:round; }
.spark .area{ fill:rgba(99,91,255,.12); }

/* group scales in when tooltip opens */
.reveal{
  transform-origin:left center;
  transform:scaleX(0);
  transition:transform .6s cubic-bezier(.2,.8,.2,1);
}
.tooltip.open .reveal{ transform:scaleX(1); }

/* line draws itself */
.animate-stroke{
  stroke-dasharray: var(--len);
  stroke-dashoffset: var(--len);
  transition: stroke-dashoffset .9s ease .1s;
}
.tooltip.open .animate-stroke{ stroke-dashoffset: 0; }

/* area fades/slides in */
.animate-fill{
  opacity:0;
  transform: translateY(6px);
  transition: opacity .6s ease .15s, transform .6s ease .15s;
}
.tooltip.open .animate-fill{ opacity:1; transform:none; }


  /* Overlay + Share */
  .media::after{content:"";position:absolute;left:0;right:0;bottom:0;height:80%;background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));opacity:0;transition:opacity .25s;pointer-events:none;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius);z-index:1}
  .media:hover::after,.media.dragging::after{opacity:1}
  .overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;gap:6px;padding:14px 12px;pointer-events:none;z-index:2}
  .overlay .line{color:#fff;opacity:0;transform:translateY(10px) scale(.98);filter:blur(6px);transition:opacity .28s, transform .55s, filter .35s}
  .media:hover .overlay .line,.media.dragging .overlay .line{opacity:1;transform:none;filter:blur(0)}
  .overlay .tag{font-size:10px;letter-spacing:.08em;text-transform:uppercase;opacity:.9}
  .overlay .h{font-weight:600;font-size:14px;line-height:1.2}
  .overlay .sub{font-size:12px;opacity:.9}
  .overlay .share{display:flex;justify-content:flex-end}
  .share-btn{pointer-events:auto;background:rgba(255,255,255,.15);border:none;border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;transition:background .25s, transform .25s}
  .share-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}

  /* Chip tooltips */
  .tip-wrap{position:relative;display:inline-block}
  .tip{position:absolute;bottom:155%;left:50%;transform:translateX(-50%);width:240px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,.14);padding:10px;font-size:12px;color:#6b7280;line-height:1.35;display:none;z-index:30}
  .tip::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%) rotate(45deg);width:10px;height:10px;background:#fff;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
  .tip-wrap:hover .tip,.tip-wrap:focus-within .tip{display:block;animation:pop .12s ease-out}

  /* Verified badge */
  .v-wrap{position:relative;display:inline-block}
  .v-badge{pointer-events:auto;display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#0095F6;color:#fff;border:0;padding:0;box-shadow:0 2px 6px rgba(0,149,246,.35);cursor:help;transition:transform .15s, box-shadow .15s}
  .v-badge:hover{transform:scale(1.08);box-shadow:0 3px 10px rgba(0,149,246,.4)}
  .small--org{position:relative;padding-right:22px}
  .small--org .v-wrap{position:absolute;right:0;top:50%;transform:translateY(-50%)}
  .v-tip{position:absolute;bottom:175%;right:0;width:220px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,.14);padding:10px;font-size:12px;color:#6b7280;display:none;z-index:30}
  .v-tip::after{content:"";position:absolute;top:100%;right:6px;transform:rotate(45deg);width:10px;height:10px;background:#fff;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
  .v-wrap:hover .v-tip,.v-wrap:focus-within .v-tip{display:block;animation:pop .12s ease-out}


/* lock page scroll; scroll only inside the builder */
/* блокируем общий скролл страницы, скролл только внутри колонок */
html, body { height: 100%; }
body { overflow: hidden; }

/* сетка: страницы ровно пополам по ширине и на всю высоту */
.layout{
  display:grid;
  grid-template-columns: 0.5fr 1.5fr;      /* половина на половину */
  gap:24px;
  align-items:start;
  padding:16px 24px;
  height: 100svh;                       /* стабильная высота вьюпорта */
  overflow:hidden;
}

/* левая колонка (форма) — собственный скролл */
.builder{
  height:100%;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-gutter: stable;
  padding:20px 24px 24px;                /* больше внутренние отступы у формы */
  box-sizing:border-box;
  padding-bottom: max(24px, env(safe-area-inset-bottom, 24px));
}

/* правая колонка — карточка по центру, свой скролл в пределах окна */
.preview{
  position: sticky;
  top: 16px;
  align-self: start;
  height: calc(100svh - 32px);

  display: grid;
  place-items: center;
  padding: 12px 0;

  overflow: auto;                      /* прокрутка ТОЛЬКО внутри превью */
  scrollbar-gutter: stable;
  overscroll-behavior: contain;
}

/* чтобы карточка не растягивалась по ширине превью */
.preview .p-col{ width: max-content; }

/* «плоская» картинка (не панорама) — красиво подрезаем */
.media img.flat{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;                    /* без искажений */
}

/* мобильный фоллбек: одна колонка и обычный скролл страницы */
@media (max-width:900px){
  body{ overflow:auto; }
  .layout{ grid-template-columns:1fr; height:auto; }
  .preview{ position:static; height:auto; overflow:visible; }
}


/* Flat-image fallback inside the media viewport */
.media img.flat {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;   /* не искажать, заполнять */
  display: block;
}


/* label + tiny tooltip icon */
.label-line{display:flex;align-items:center;gap:8px;margin-top:10px}
.label-line label{margin:0;color:var(--muted);font-size:12px}

/* form tooltip */
.form-help{position:relative;display:inline-flex}
.form-help .ico{
  width:16px;height:16px;border-radius:50%;
  background:#eef2ff;color:#3b82f6;font-size:11px;font-weight:700;
  display:inline-flex;align-items:center;justify-content:center;
  cursor:help; user-select:none;
}
.form-tip{
  position:absolute;left:0;top:calc(100% + 8px);z-index:40;
  width:280px;max-width:70vw;
  background:#fff;border:1px solid var(--border);border-radius:10px;
  box-shadow:0 12px 32px rgba(0,0,0,.14);
  padding:10px;font-size:12px;color:#6b7280;line-height:1.35;display:none;
}
.form-tip::after{
  content:"";position:absolute;top:-6px;left:10px;width:10px;height:10px;
  background:#fff;border-left:1px solid var(--border);border-top:1px solid var(--border);
  transform:rotate(45deg)
}
.form-help:hover .form-tip,.form-help:focus-within .form-tip{display:block;animation:pop .12s ease-out}

/* subdued input */
.input-subdued::placeholder{color:#9ca3af;opacity:1}
.input-subdued{color:#374151}
.input-subdued:focus{color:#111827}

/* маленькая надпись с ID, такого же размера как label */
.project-id {
  font-size: 12px;
  color: var(--muted);
  text-align: right;
  margin-top: 4px;
  font-variant-numeric: tabular-nums;
}

.field{display:flex;flex-direction:column;gap:6px}
.field label{margin:0;color:var(--muted);font-size:12px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}

/* общий отступ блока поля */
.field-block{ margin-top:12px; }

/* строка с чекбоксом — как «поле на всю ширину» */
.check-row{
  display:flex; align-items:center; gap:8px;
  padding:6px 0; /* визуально на одной линии с инпутами */
}
.check-row input[type="checkbox"]{ margin:0; }

/* универсальные контейнеры для полей */
.field-block { margin-top: 12px; }
/* раньше было 3 колонки — делаем одну */
.grid-3{
  display: grid;
  grid-template-columns: 1fr;  /* одна колонка */
  gap: 10px;                   /* расстояние между полями */
}

.field { display: flex; flex-direction: column; gap: 6px; }

/* чекбоксы в одну линию, вертикально по центру */
.check-row { display:flex; align-items:center; gap:8px; }

/* базовая 2-колоночная сетка остаётся прежней */
.grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* только этот ряд складываем в одну колонку */
.grid-2.org-stack{ grid-template-columns:1fr; }

/* ровняем чекбокс по центру строки */
.chk{ display:flex; align-items:center; gap:8px; }

/* Inline checkbox aligned with label + tooltip */
.inline-control{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:10px;
}
.inline-control .label-line{
  margin:0;
  flex:1 1 auto;           /* текст/tooltip тянутся */
  min-width:0;
}
.inline-control input[type="checkbox"]{
  margin:0;
  width:18px;
  height:18px;
  flex:0 0 auto;           /* чекбокс справа */
}

.chk-line{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:10px;
}

.inline-control{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:10px;
}


.inline-control{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px}
.inline-control .label-line{margin:0;flex:1 1 auto;min-width:0}
.inline-control input[type="checkbox"]{margin:0;width:18px;height:18px;flex:0 0 auto}


/* inline checkbox: [□] Label  (i) */
.inline-check{
  display:flex;
  align-items:center;
  gap:8px;            /* расстояние между чекбоксом, лейблом и (i) */
  margin-top:10px;
}
.inline-check input[type="checkbox"]{ margin:0; width:18px; height:18px; }
.inline-check label{ margin:0; font-size:12px; color:var(--muted); }
.inline-check .form-help{ margin-left:2px; }  /* иконка "i" сразу после лейбла */

/* Title link: animated underline + focus ring */
.title a[data-project-link]{
  position:relative;
  display:inline-block;
  text-decoration:none;
  color:inherit;
  border-radius:8px;                /* для красивого focus ring */
  transition:transform .2s ease;
}
.title a[data-project-link]::after{
  content:"";
  position:absolute;
  left:0; right:0; bottom:-2px;
  height:2px;
  background:linear-gradient(90deg,var(--primary),#a78bfa);
  transform:scaleX(0);
  transform-origin:left;
  opacity:.0;
  transition:transform .35s cubic-bezier(.2,.8,.2,1), opacity .2s ease;
}
.title a[data-project-link]:hover::after,
.title a[data-project-link]:focus-visible::after{
  transform:scaleX(1);
  opacity:1;
}
.title a[data-project-link]:hover{
  transform:translateY(-1px);
}
.title a[data-project-link]:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(99,91,255,.28);
}

/* --- Thumbnails gallery under dropzone --- */
.dz-gallery{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
  gap:8px;
  margin-top:8px;
}

.thumb{
  position:relative;
  aspect-ratio:1/1;
  border:1px solid var(--border);
  border-radius:8px;
  overflow:hidden;
  background:#f3f4f6;
}
.thumb img{
  width:100%; height:100%; object-fit:cover; display:block;
}
.thumb .remove{
  position:absolute; top:4px; right:4px;
  width:22px; height:22px; border:0; border-radius:50%;
  background:#111827; color:#fff; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:14px; line-height:1;
}
.thumb .badge{
  position:absolute; left:4px; bottom:4px;
  font-size:10px; background:#fff; border:1px solid var(--border);
  border-radius:6px; padding:2px 6px;
}
.thumb.active{ outline:2px solid var(--primary); outline-offset:2px; }
.dz-name{ grid-column:1 / -1; font-size:12px; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }


/* Dots INSIDE the image */
.pager-in{
  position:absolute;
  left:0; right:0; bottom:10px;
  display:flex; justify-content:center; gap:6px;
  z-index:3;                 /* выше .overlay (у неё z-index:2) */
  pointer-events:auto;       /* кликаются */
}

/* чистая круглая точка, очень маленькая */
.pager-in .dot{
  width:6px; height:6px;
  border-radius:50%;
  padding:0;                 /* иначе превращается в «овал» */
  border:1.25px solid hsla(0,0%,100%,.95);
  background:transparent;
  opacity:.9;
  cursor:pointer;
  display:inline-block;
  position:relative;         /* для hit-area */
  appearance:none; -webkit-appearance:none;
  transition:transform .12s ease, opacity .12s ease;
}

/* увеличить невидимую зону клика, сама точка остаётся маленькой */
.pager-in .dot::after{
  content:"";
  position:absolute; inset:-6px;
}

/* активная точка — заливка белым */
.pager-in .dot[aria-current="true"]{
  background:#fff;
  border-color:#fff;
}

/* фокус/hover — чуть-чуть, без анимаций */
.pager-in .dot:hover{ transform:scale(1.15); }
.pager-in .dot:focus-visible{
  outline:0;
  box-shadow:0 0 0 3px rgba(255,255,255,.35);
}





</style>
</head>
<body>

<div class="layout">
  <!-- LEFT: FORM -->
  <form id="card-form" class="builder" autocomplete="off">
    <h3>Card Builder</h3>


    


    <div class="label-line">
  <label for="title1">Title (before dash)</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-title1">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-title1" role="tooltip">
  Main part of the project title (before ‘—’). This value also generates the public
  <em>project page URL</em>, and the card’s title becomes a clickable link.
  Example: “Queensway Carleton Hospital” → <code>ishare.ca/queenswaycarletonhospital</code>.
  Keep it short. The part after the dash goes into the “Action” field below.
  Changes appear in real time in the preview on the right.
</span>

  </span>
</div>



<!-- 6-значный ЧИСЛОВОЙ ID только как текст (не редактируется) -->
<div class="project-id">ID: <span id="pidBadge">—</span></div>
<input type="hidden" name="projectId" id="projectId">



<input id="title1" name="title1" class="input-subdued"
       placeholder="e.g. Queensway Carleton Hospital"
       value="Queensway Carleton Hospital">




    <div class="label-line">
  <label for="title2">Action (after dash)</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-title2">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-title2" role="tooltip">
      Short action phrase that follows the dash, e.g. “Dedicate a Unit”.
    </span>
  </span>
</div>
<input id="title2" name="title2" class="input-subdued"
       placeholder="e.g. Dedicate a Unit"
       value="Dedicate a Unit">


    <div class="label-line">
  <label for="overlayH">Overlay header</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-overlayH">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-overlayH" role="tooltip">
      Short headline shown on the image (bottom of the card). Appears on hover.
      Keep it to 3–6 words, no period. Example: “Inside the hospital wing”.
    </span>
  </span>
</div>
<input id="overlayH" name="overlayH" class="input-subdued" value="Inside the hospital wing">

<div class="label-line">
  <label for="overlaySub">Overlay sub</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-overlaySub">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-overlaySub" role="tooltip">
      Small line under the header — usually tags like “VR · XR” or “360° · Walkthrough”.
      Keep it concise, around 25–30 characters.
    </span>
  </span>
</div>
<input id="overlaySub" name="overlaySub" class="input-subdued" value="VR · XR">


   <div class="label-line">
  <label for="panoFile">Panorama / photo</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-pano">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-pano" role="tooltip">
      Drop a 360° equirectangular image (JPG/PNG/WEBP, ideally 6000×3000 or 4096×2048, up to 20 MB), 
      or a regular photo. We’ll detect the type automatically. Changes appear in real time on the preview.
    </span>
  </span>
</div>

<div id="panoDrop" class="dropzone" tabindex="0" aria-label="Upload panorama(s)">
  
  <span class="dz-text">Drag your panoramas here or click</span>

  <!-- ВАЖНО: multiple -->
  <input id="panoFile" type="file" accept=".jpg,.jpeg,.png,.webp,image/*" multiple hidden>

  <label for="panoFile" class="dz-btn">Choose files</label>
  <span id="panoFileName" class="dz-name"></span>
</div>

<!-- НОВОЕ: превью загруженных панорам с крестиками -->
<div id="panoGallery" class="dz-gallery" aria-live="polite"></div>











    <div class="label-line">
  <label for="sector">Sector</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-sector">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-sector" role="tooltip">
      Choose the project’s category. This becomes the first chip on the card
      and helps donors quickly understand the cause. Changes update the preview in real time.
    </span>
  </span>
</div>

<select id="sector" name="sector">
  <option>Health Care</option>
  <option>Education</option>
  <option>Culture</option>
  <option>Community</option>
  <option>Disaster Relief</option>
  <option>Faith</option>
  <option>International Aid</option>
  <option>Tourism</option>
</select>


    <div class="chk-line">
  <label for="tax" class="row-inline" style="margin:0">
    <input id="tax" type="checkbox" name="tax" checked aria-describedby="tip-tax">
    Tax-deductible
  </label>

  <!-- info icon (не меняет состояние чекбокса) -->
  <span class="form-help" tabindex="0" aria-describedby="tip-tax" onclick="event.stopPropagation()">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-tax" role="tooltip">
      If enabled, the card shows a “Tax-deductible” chip. Donations may be
      eligible for an official tax receipt (subject to local regulations).
    </span>
  </span>
</div>


    <div class="label-line">
  <label for="matching">Matching</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-matching">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-matching" role="tooltip">
      Select the sponsor match multiplier. For example, 2× means every $1 donated is doubled by the sponsor (up to the campaign’s cap or deadline).
    </span>
  </span>
</div>
<select id="matching" name="matching">
  <option value="none">No matching</option>
  <option value="1.5">1.5× matching</option>
  <option value="2" selected>2× matching</option>
  <option value="3">3× matching</option>
</select>

<!-- helper chip — как у AI Agent -->
<div class="chk-line">
  <label for="matchHelper" class="row-inline" style="margin:0">
    <input id="matchHelper" type="checkbox" name="matchHelper" checked aria-describedby="tip-matchhelper">
    Show helper chip “sponsor adds $X”
  </label>
  <span class="form-help" tabindex="0" aria-describedby="tip-matchhelper" onclick="event.stopPropagation()">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-matchhelper" role="tooltip">
      Adds a chip that spells out the extra $ the sponsor contributes per $1 given (e.g., $1 for 2×, $2 for 3×).
    </span>
  </span>
</div>



<!-- AI Agent -->
<div class="chk-line">
  <label for="aiAgent" class="row-inline" style="margin:0">
    <input id="aiAgent" type="checkbox" name="aiAgent" checked aria-describedby="tip-ai">
    AI Agent · 24/7
  </label>
  <span class="form-help" tabindex="0" aria-describedby="tip-ai" onclick="event.stopPropagation()">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-ai" role="tooltip">
      Always-on assistant that answers donor questions and guides giving 24/7.
    </span>
  </span>
</div>


    <div class="grid-3">
  <!-- Progress % -->
  <div class="field">
    <div class="label-line">
      <label for="progress">Progress %</label>
      <span class="form-help" tabindex="0" aria-describedby="tip-progress">
        <span class="ico" aria-hidden="true">i</span>
        <span class="form-tip" id="tip-progress" role="tooltip">
          Percentage of goal reached (0–100). Controls the bar and the % label on the card.
        </span>
      </span>
    </div>
    <input id="progress" name="progress" type="number" min="0" max="100" step="1" value="55">
  </div>

  <!-- Raised (number) -->
  <div class="field">
    <div class="label-line">
      <label for="raised">Raised (number)</label>
      <span class="form-help" tabindex="0" aria-describedby="tip-raised">
        <span class="ico" aria-hidden="true">i</span>
        <span class="form-tip" id="tip-raised" role="tooltip">
          Total amount raised so far. Used in the “$… raised” label and the stats tooltip.
        </span>
      </span>
    </div>
    <input id="raised" name="raised" type="number" min="0" step="100" value="87400">
    <!-- Graph months -->
<div class="field">
  <div class="label-line">
    <label for="raisedMonths">Months on graph</label>
    <span class="form-help" tabindex="0" aria-describedby="tip-raisedMonths">
      <span class="ico" aria-hidden="true">i</span>
      <span class="form-tip" id="tip-raisedMonths" role="tooltip">
        How many months to display in the tooltip chart (min 2, max 24).
      </span>
    </span>
  </div>
  <input id="raisedMonths" name="raisedMonths" type="number" min="2" max="24" step="1" value="3">
</div>

  </div>

  <!-- Days left -->
  <div class="field">
    <div class="label-line">
      <label for="daysLeft">Days left</label>
      <span class="form-help" tabindex="0" aria-describedby="tip-days">
        <span class="ico" aria-hidden="true">i</span>
        <span class="form-tip" id="tip-days" role="tooltip">
          Number of days remaining for the campaign. Shown as a blue line on the card.
        </span>
      </span>
    </div>
    <input id="daysLeft" name="daysLeft" type="number" min="0" step="1" value="40">
  </div>
</div>



    <!-- Naming -->
<div class="field-block">
  <div class="label-line">
    <label for="naming">Naming</label>
    <span class="form-help" tabindex="0" aria-describedby="tip-naming">
      <span class="ico" aria-hidden="true">i</span>
      <span class="form-tip" id="tip-naming" role="tooltip">
        How many naming items are available/remaining. Shown on the card as “Naming: …”.
      </span>
    </span>
  </div>
  <input id="naming" name="naming" value="120 available of 270">
</div>

    <div class="grid-2 org-stack">
  <div class="field">
    <div class="label-line">
      <label for="orgName">Organization</label>
      <span class="form-help" tabindex="0" aria-describedby="tip-orgName">
        <span class="ico" aria-hidden="true">i</span>
        <span class="form-tip" id="tip-orgName" role="tooltip">
          Official organization name. It appears under the card title.
        </span>
      </span>
    </div>
    <input id="orgName" name="orgName" class="input-subdued"
           placeholder="Organization name"
           value="Queensway Carleton Hospital Foundation">
  </div>

  <div class="field">
    <div class="label-line">
      <label for="orgUrl">Org URL</label>
      <span class="form-help" tabindex="0" aria-describedby="tip-orgUrl">
        <span class="ico" aria-hidden="true">i</span>
        <span class="form-tip" id="tip-orgUrl" role="tooltip">
          Public website link for the organization. Opens in a new tab.
        </span>
      </span>
    </div>
    <input id="orgUrl" name="orgUrl" type="url" class="input-subdued"
           placeholder="https://example.org"
           value="https://qchfoundation.ca/">
  </div>
</div>

<!-- Verified badge -->
<div class="chk-line">
  <label for="verified" class="row-inline" style="margin:0">
    <input id="verified" type="checkbox" name="verified" checked aria-describedby="tip-verified">
    Verified badge
  </label>
  <span class="form-help" tabindex="0" aria-describedby="tip-verified" onclick="event.stopPropagation()">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-verified" role="tooltip">
      Shows a blue check next to the organization to indicate it was reviewed by our team.
    </span>
  </span>
</div>




    <div class="label-line">
  <label for="tiers">Tiers</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-tiers">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-tiers" role="tooltip">
      Enter one tier per line in the format “Label | Right text”.<br>
      The part before the bar is the tier name; the part after the bar
      is shown right-aligned (e.g., price and availability).<br><br>
      Examples:<br>
      Operating Room Sponsorship | $25k · 2 left<br>
      Patient Care Grant | $5k · 15 left
    </span>
  </span>
</div>
<textarea id="tiers" name="tiers">Operating Room Sponsorship | $25k · 2 left
Patient Care Grant | $5k · 15 left
Donor Wall Recognition | $1k · 60 left</textarea>


    <div class="builder-grid">
      <div class="label-line">
  <label for="yaw">Start yaw (°)</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-yaw">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-yaw" role="tooltip">
      Horizontal starting angle of the panorama camera. 0° faces the image’s
      default forward direction; positive values rotate to the right (clockwise).
      Any number works (0–360 is typical).
    </span>
  </span>
</div>
<input id="yaw" name="yaw" type="number" value="200">

      <div class="label-line">
  <label for="pitch">Start pitch (°)</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-pitch">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-pitch" role="tooltip">
      Vertical starting angle of the panorama camera. 0° is level (horizon);
      positive values tilt up, negative values tilt down. Typically limited to
      about −85°…+85° to avoid poles.
    </span>
  </span>
</div>
<input id="pitch" name="pitch" type="number" value="0">



    </div>
    <label class="row-inline"><input type="checkbox" name="wheelZoom"> Enable wheel zoom</label>
    <div class="label-line">
  <label for="autoRotate">Auto-rotate (deg/sec)</label>
  <span class="form-help" tabindex="0" aria-describedby="tip-autorotate">
    <span class="ico" aria-hidden="true">i</span>
    <span class="form-tip" id="tip-autorotate" role="tooltip">
      Speed of automatic rotation in degrees per second. Set to 0 to disable.
      Rotation pauses while you drag, then resumes. Typical range: 0.5–2.
    </span>
  </span>
</div>
<input id="autoRotate" name="autoRotate" type="number" min="0" step="0.1" value="1">



    <div class="actions">
  <button type="button" id="launch" class="btn">Launch campaign</button>
  <button type="button" id="save" class="btn secondary">Save</button>
  <button type="button" id="load" class="btn secondary">Load last</button>
  <button type="button" id="copy-html" class="btn secondary">Copy card HTML</button>
</div>

  </form>

  <!-- RIGHT: PREVIEW -->
  <div class="preview" id="preview"></div>
</div>

<!-- CARD TEMPLATE -->
<template id="card-tpl">
  <div class="p-col">
    <article class="card" aria-label="">
      <div class="media" data-pano>
        <div class="loader" data-loader>Loading 360°…</div>
        <div class="overlay">
          <div class="line tag">360° PANORAMA</div>
          <div class="line h" data-text="overlayH">Inside the hospital wing</div>
          <div class="line sub" data-text="overlaySub">VR · XR</div>
          <div class="line share">
            <button class="share-btn" aria-label="Share">
              <!-- classic share -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="18" fill="currentColor" aria-hidden="true">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.5 2.5 0 0 0 0-1.39l7.05-4.11A2.5 2.5 0 1 0 14.5 5a2.5 2.5 0 0 0 0 .22l-7.05 4.11a2.5 2.5 0 1 0 0 5.34l7.05 4.11a2.5 2.5 0 1 0 .5-1.9z"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="pager-in" data-pager></div>

      </div>

      <h2 class="title">
  <a data-project-link href="#" target="_blank" rel="noopener noreferrer"
     style="text-decoration:none;color:inherit">
    <span data-text="title1">Title</span> —<br>
    <span data-text="title2">Action</span>
  </a>
</h2>

      <div class="small small--id">ID: <span data-text="projectId"></span></div>




      <div class="chips" data-chips></div>

      <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i style="width:0%"></i></div>

      <div class="row small stats">
        <span class="raised" tabindex="0" aria-describedby=""><span data-text="raisedLabel">$0 raised</span></span>
        <span data-text="progressPct">0%</span>
        <div class="tooltip" role="tooltip" aria-hidden="true">
          <div class="tt-h">Raised over last 3 months</div>
          <svg class="spark" viewBox="0 0 220 80" width="220" height="80" aria-hidden="true">
            <path class="grid" d="M10 60 H210 M10 35 H210" />
            <g class="reveal"><path class="area"></path><path class="line"></path></g>
          </svg>
          <div class="tt-f"><strong data-text="raisedTotal">$0</strong> total · 3 months</div>
        </div>
      </div>

      <div class="small">Naming: <span data-text="naming">0 available of 0</span></div>
      <div class="small" data-text="location">City, ST</div>

      <div class="small small--org">
        by <a class="org" href="#" data-text="orgName">Organization</a>
        <span class="v-wrap" data-verified style="display:none">
          <button class="v-badge" aria-label="Verified organization">
            <svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path fill="currentColor" d="M20.285 6.709l-11 11-5.657-5.657 1.414-1.414L9.285 14.59l9.586-9.586z"/></svg>
          </button>
          <span class="v-tip" role="tooltip"><strong>Verified</strong> — this organization has been reviewed and confirmed by our team.</span>
        </span>
      </div>

      <div class="accent" data-text="daysLeft">0 days left</div>

      <div class="tiers">
        <button class="tier-link" type="button" aria-expanded="false">View naming tiers</button>
        <div class="tier-menu" role="menu" hidden data-tiers></div>
      </div>
    </article>
  </div>
</template>

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';


const DEFAULT_PANO = new URL('./img/pano/panorama.jpg', document.baseURI).href;


// базовый домен для страниц лотов
const PROJECT_BASE = 'https://ishare.ca/';


const MAX_PANOS = 12;
let panoList = [];   // будет сохраняться и загружаться вместе с формой



let activePanoIndex = 0;
function clampActive(){
  if (!panoList.length) { activePanoIndex = 0; return; }
  if (activePanoIndex < 0) activePanoIndex = 0;
  if (activePanoIndex >= panoList.length) activePanoIndex = panoList.length - 1;
}

function setPanoHiddenToActive(){
  ensurePanoHiddenInput();
  clampActive();
  const current = getPanoCandidates()[0] || DEFAULT_PANO; // см. п.2 — там активный идёт первым
  form.querySelectorAll('input[name="panoSrc"]').forEach(el => el.value = current);
}



// простая транслитерация кириллицы → латиница (на всякий)
const _ru = { 'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'zh','з':'z','и':'i','й':'y',
  'к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h',
  'ц':'c','ч':'ch','ш':'sh','щ':'sch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya' };
function translitRU(s){ return String(s||'')
  .toLowerCase()
  .replace(/[а-яё]/g, ch => _ru[ch] ?? ch); }

// из Title → slug без пробелов/знаков
function titleToProductUrl(title){
  const latin = translitRU(title).normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
  const slug  = latin.replace(/[^a-z0-9]+/g,'').slice(0,80);
  return slug ? PROJECT_BASE + slug : '';
}






/* Helpers */

// ↓ поставить рядом с другими helpers
function downscaleToDataURL(src, maxW = 1280, maxH = 1280, quality = 0.82){
  return new Promise(resolve=>{
    const im = new Image();
    im.onload = ()=>{
      let w = im.naturalWidth || im.width;
      let h = im.naturalHeight || im.height;
      // только уменьшаем, не увеличиваем
      const k = Math.min(maxW / w, maxH / h, 1);
      const tw = Math.round(w * k), th = Math.round(h * k);
      const c = document.createElement('canvas'); c.width = tw; c.height = th;
      const ctx = c.getContext('2d');
      ctx.drawImage(im, 0, 0, tw, th);
      // всегда JPEG — сильно экономит
      resolve(c.toDataURL('image/jpeg', quality));
    };
    im.onerror = ()=> resolve(src); // если не смогли — отдаём как есть
    im.crossOrigin = 'anonymous';   // на случай относительных путей
    im.src = src;
  });
}




function getCatalogItemsSafe(){
  try { return JSON.parse(localStorage.getItem('catalogItems') || '[]'); }
  catch { return []; }
}
function listExistingIds(){
  return new Set(getCatalogItemsSafe().map(x => String(x?.projectId ?? '')));
}
function mintUniqueId6(){
  const used = listExistingIds();
  // пробуем до 1000 раз случайный 6-значный
  for (let t = 0; t < 1000; t++){
    const id = String(Math.floor(Math.random() * 1e6)).padStart(6,'0');
    if (!used.has(id)) return id;
  }
  // резерв: последовательный счётчик
  let seq = parseInt(localStorage.getItem('catalogIdSeq') || '420000', 10);
  if (!Number.isFinite(seq)) seq = 420000;
  seq = (seq + 1) % 1000000;
  localStorage.setItem('catalogIdSeq', String(seq));
  return String(seq).padStart(6,'0');
}


// ↓↓↓ добавить рядом с другими хелперами
async function shrinkDataURL(dataUrl, maxW = 1600, quality = 0.8){
  if (!/^data:image\//.test(dataUrl)) return dataUrl;
  const img = new Image();
  const loaded = new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; });
  img.src = dataUrl;
  await loaded;
  const scale = Math.min(1, maxW / (img.naturalWidth || 1));
  const w = Math.max(1, Math.round((img.naturalWidth || 1) * scale));
  const h = Math.max(1, Math.round((img.naturalHeight || 1) * scale));
  const cvs = document.createElement('canvas'); cvs.width = w; cvs.height = h;
  const ctx = cvs.getContext('2d', { alpha:false });
  ctx.drawImage(img, 0, 0, w, h);
  // jpeg даёт кратно меньший размер, прозрачность нам не нужна
  return cvs.toDataURL('image/jpeg', quality);
}

// Подготовить галерею к сохранению в каталог (не вылететь по квоте)
// было: только 4 штуки
// стало: все до MAX_PANOS, с лёгкой компрессией
async function prepareGalleryForCatalog({limit = MAX_PANOS, targetW = 1120, targetH = 1120, quality = 0.78} = {}){
  // исходный список
  const srcList = (Array.isArray(panoList) && panoList.length)
    ? panoList.slice(0, limit)
    : [ form.querySelector('input[name="panoSrc"]')?.value || DEFAULT_PANO ];

  // активную ставим первой
  clampActive();
  const list = srcList.slice();
  const a = Math.min(activePanoIndex, list.length - 1);
  if (a > 0) [list[0], list[a]] = [list[a], list[0]];

  // компрессия в dataURL (безопасно для localStorage)
  const compact = [];
  for (const src of list){
    compact.push(await downscaleToDataURL(src, targetW, targetH, quality));
  }
  return { compact, idx: 0, cover: compact[0] };
}




  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const uid = (p='id') => p + '-' + Math.random().toString(36).slice(2,8);
  const money = n => '$' + Number(n||0).toLocaleString('en-US');

  /* Проверка существующего пути (не трогаем blob:/data:) */
  function pickExisting(paths){
    return new Promise(resolve=>{
      let i=0;(function tryNext(){
        if(i>=paths.length){ resolve(null); return; }
        let p = paths[i++], im = new Image();
        const special = p.startsWith('blob:') || p.startsWith('data:');
        im.onload = ()=>resolve(p);
        im.onerror = tryNext;
        im.src = special ? p : p + (p.includes('?')?'&':'?') + 'v=' + Date.now();
      })();
    });
  }

  /* ИНИЦИАЛИЗАЦИЯ ПАНОРАМЫ ПО ЭЛЕМЕНТАМ (ленивая) */
  /* ИНИЦИАЛИЗАЦИЯ МЕДИА: панорама (2:1) → three.js, иначе — плоская картинка */
function initPanoEl(container, loaderEl, candidates, opts = {}) {
  if (!container || !loaderEl) return () => {};

  let lon = Number(opts.yaw || 0), lat = Number(opts.pitch || 0);
  const autoDegPerSec = Number(opts.autoRotate || 0);
  const allowWheel    = !!opts.wheelZoom;

// NEW: faster drag + inertia (damping)
  const dragSpeed = Number(opts.dragSpeed ?? 0.22);        // было ~0.12, теперь быстрее
 const inertia   = Math.min(0.99, Math.max(0, Number(opts.inertia ?? 0.90)));
  const stopEPS   = 0.001;                                 // когда скорость почти 0 — останавливаем
 let velLon = 0, velLat = 0;                              // «скорость» в градусах/кадр

  
  const first = (candidates && candidates[0]) || '';
  const isSpecial = first.startsWith('blob:') || first.startsWith('data:');
  const loadPathPromise = isSpecial ? Promise.resolve(first) : pickExisting(candidates);

  return (() => {
    let cleanup = () => {};
    loadPathPromise.then((path) => {
      if (!path) { loaderEl.textContent = 'Panorama not found'; return; }

      const probe = new Image();
      probe.onload = () => {
        const ratio  = probe.naturalWidth / probe.naturalHeight;
        const isPano = isFinite(ratio) && ratio > 1.7 && ratio < 2.3;

        if (!isPano) {
          loaderEl.classList.add('hidden');
          const img = document.createElement('img');
          img.className = 'flat';
          img.alt = 'Image';
          img.src = path;
          container.appendChild(img);
          cleanup = () => { if (img.parentNode) img.remove(); };
          return;
        }

        // --- three.js ---
        let renderer, scene, camera, animId;
        let isDragging = false, onDownLon = 0, onDownLat = 0, startX = 0, startY = 0;

        function resize(){
          const w = container.clientWidth, h = container.clientHeight;
          if (!w || !h || !camera || !renderer) return;
          camera.aspect = w/h; camera.updateProjectionMatrix();
          renderer.setSize(w,h,false);
        }
        function onPointerDown(e){
          isDragging = true;
          container.classList.add('dragging');
          startX = e.clientX; startY = e.clientY;
          onDownLon = lon; onDownLat = lat;
          velLon = 0; velLat = 0;                     // сбрасываем инерцию при новом захвате
        }
        function onPointerMove(e){
          if(!isDragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const newLon = onDownLon - dx * dragSpeed;   // быстрее отклик
          const newLat = Math.max(-85, Math.min(85, onDownLat + dy * dragSpeed));
          velLon = newLon - lon;                       // накапливаем скорость для «броска»
          velLat = newLat - lat;
          lon = newLon; lat = newLat;
        }
        function onPointerUp(){ isDragging=false; container.classList.remove('dragging'); }
        function onWheel(e){ if(!allowWheel) return; const f=Math.max(40,Math.min(90,(camera?.fov||75)+e.deltaY*0.03)); camera.fov=f; camera.updateProjectionMatrix(); }
        function render(){ renderer.render(scene,camera); }
        function animate(){
  animId = requestAnimationFrame(animate);

  if(!isDragging){
    if (autoDegPerSec){ lon += (autoDegPerSec/60); } // авто-вращение, если задано
    // инерция
    lon += velLon; lat += velLat;
    velLon *= inertia; velLat *= inertia;
    if (Math.abs(velLon) < stopEPS) velLon = 0;
    if (Math.abs(velLat) < stopEPS) velLat = 0;
    if (lat > 85) { lat = 85; velLat = 0; }
    if (lat < -85){ lat = -85; velLat = 0; }
  }

  const phi = THREE.MathUtils.degToRad(90 - lat);
  const theta = THREE.MathUtils.degToRad(lon);
  camera.lookAt(new THREE.Vector3(
    500*Math.sin(phi)*Math.cos(theta),
    500*Math.cos(phi),
    500*Math.sin(phi)*Math.sin(theta)
  ));
  render();
}


        scene  = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(120, 1, 0.1, 1100);
        const geo = new THREE.SphereGeometry(500, 60, 40); geo.scale(-1,1,1);
        const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        const mesh = new THREE.Mesh(geo, mat);
        scene.add(mesh);

        renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 1.5));
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        container.appendChild(renderer.domElement);

        let texRef = null;
        new THREE.TextureLoader().load(path, (tex)=>{
          tex.colorSpace = THREE.SRGBColorSpace;
          tex.minFilter  = THREE.LinearFilter;
          texRef = tex;
          mat.map = tex; mat.needsUpdate = true;
          loaderEl.classList.add('hidden');
          render();
        }, undefined, ()=>{ loaderEl.textContent = 'Failed to load pano'; });

        resize();
        const ro = new ResizeObserver(resize);
        ro.observe(container);

        container.addEventListener('pointerdown', onPointerDown);
        container.addEventListener('pointermove',  onPointerMove);
        container.addEventListener('pointerup',    onPointerUp);
        container.addEventListener('pointerleave', onPointerUp);
        container.addEventListener('wheel', onWheel, {passive:true});

        const visHandler = () => { if(document.hidden) cancelAnimationFrame(animId); else animate(); };
        document.addEventListener('visibilitychange', visHandler);

        animate();

        cleanup = () => {
          cancelAnimationFrame(animId);
          document.removeEventListener('visibilitychange', visHandler);
          ro.disconnect();
          container.removeEventListener('pointerdown', onPointerDown);
          container.removeEventListener('pointermove',  onPointerMove);
          container.removeEventListener('pointerup',    onPointerUp);
          container.removeEventListener('pointerleave', onPointerUp);
          container.removeEventListener('wheel', onWheel, {passive:true});
          try { if (renderer?.domElement?.parentNode === container) container.removeChild(renderer.domElement); } catch {}
          try { texRef?.dispose?.(); } catch {}
          try { mat.dispose(); } catch {}
          try { geo.dispose(); } catch {}
          try { renderer?.dispose?.(); } catch {}
        };
      };

      probe.onerror = () => { loaderEl.textContent = 'Failed to load image'; };
      probe.src = isSpecial ? path : path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
    });

    return () => cleanup();
  })();
}

    

  /* Template → DOM helpers */
  function fillTexts(root, data){
  $$('[data-text]',root).forEach(n=>{
    const k = n.dataset.text;
    if (k === 'orgName') {
      n.textContent = data.orgName || '';
      n.setAttribute('href', data.orgUrl || '#');
      n.setAttribute('target', '_blank');               // open in new tab
      n.setAttribute('rel', 'noopener noreferrer');     // security
    } else {
      n.textContent = data[k] ?? '';
    }
  });
}

function getOrCreateNumericId(){
  let pid = form.elements.projectId?.value || localStorage.getItem('cardProjectId');
  if (!/^\d{6}$/.test(pid)) {
    pid = String(Math.floor(Math.random()*1e6)).padStart(6, '0'); // 000000–999999
    localStorage.setItem('cardProjectId', pid);
  }
  const badge = document.getElementById('pidBadge');
  if (badge) badge.textContent = pid;
  if (form.elements.projectId) form.elements.projectId.value = pid;
  return pid;
}





  function renderChips(root, chips){
  const host = root.querySelector('[data-chips]');
  host.innerHTML = '';
  (chips || []).forEach((chip) => {
    const [textRaw, tip] = String(chip).split('::');
    const text = textRaw.trim();

    // map text → class
    let cls = 'chip';
    if (/^health care$/i.test(text)) cls = 'chip health';
    else if (/^tax-deductible$/i.test(text)) cls = 'chip tax';
    else if (/×\s*matching/i.test(text)) cls = 'chip match';
    else if (/^ai agent/i.test(text)) cls = 'chip ai';

    const el = document.createElement('span');
    if (tip && tip.trim()){
      const tipId = uid('tip');
      el.className = cls + ' tip-wrap';
      el.tabIndex = 0;
      el.setAttribute('aria-describedby', tipId);
      el.innerHTML = `${text}<span class="tip" id="${tipId}" role="tooltip">${tip.trim()}</span>`;
    } else {
      el.className = cls;
      el.textContent = text;
    }
    host.appendChild(el);
  });
}


  function renderProgress(root, pct, raised, months){
  // normalize months: 2..24
  months = Math.max(2, Math.min(24, parseInt(months || 3)));

  const bar = root.querySelector('.bar'),
        fill = bar.querySelector('i'),
        stats = root.querySelector('.row.small.stats');

  bar.setAttribute('aria-valuenow', pct);
  fill.style.width = pct + '%';

  stats.querySelector('[data-text="raisedLabel"]').textContent = `${money(raised)} raised`;
  stats.querySelector('[data-text="progressPct"]').textContent  = `${pct}%`;
  stats.querySelector('[data-text="raisedTotal"]').textContent  = money(raised);

  const tip     = stats.querySelector('.tooltip'),
        raisedEl= stats.querySelector('.raised'),
        tipId   = uid('tt');

  tip.id = tipId;
  raisedEl.setAttribute('aria-describedby', tipId);

  // dynamic tooltip text
  const monthsText = `${months} ${months === 1 ? 'month' : 'months'}`;
  const ttHeader = tip.querySelector('.tt-h');
  if (ttHeader) ttHeader.textContent = `Raised over last ${monthsText}`;
  const ttFooter = tip.querySelector('.tt-f');
  if (ttFooter) ttFooter.innerHTML = `<strong data-text="raisedTotal">${money(raised)}</strong> total · ${monthsText}`;

  ['mouseenter','focus'].forEach(ev => raisedEl.addEventListener(ev, () => tip.classList.add('open')));
  ['mouseleave','blur' ].forEach(ev => raisedEl.addEventListener(ev, () => tip.classList.remove('open')));

  // --- sparkline helpers (unchanged) ---
  function buildSparkPaths(vals, w=220, h=80, pad=10){
    const mx = Math.max(...vals, 1);
    const innerW = w - pad*2, innerH = h - pad*2;
    const step = innerW / (vals.length - 1);
    let d = '';
    vals.forEach((v,i)=>{
      const x = pad + i*step;
      const y = h - pad - (v/mx)*innerH;
      d += (i ? 'L':'M') + x + ',' + y;
    });
    const area = `${d} L ${pad + innerW},${h - pad} L ${pad},${h - pad} Z`;
    return { line: d, area };
  }
  function setupSparkTooltip(tooltipEl, values){
    const svg  = tooltipEl.querySelector('svg.spark');
    const line = svg.querySelector('path.line');
    const area = svg.querySelector('path.area');

    const { line: dl, area: da } = buildSparkPaths(values);
    line.setAttribute('d', dl);
    area.setAttribute('d', da);

    const len = line.getTotalLength();
    line.style.setProperty('--len', String(len));
    line.classList.add('animate-stroke');
    area.classList.add('animate-fill');
  }

  // build series with requested months (>= 2 points)
  const points = months;
  const series = Array.from({length: points}, (_, i) =>
    Math.round((i + 1) * (raised / points) * (0.7 + Math.random() * 0.6))
  );
  setupSparkTooltip(root.querySelector('.tooltip'), series);
}



  
  function renderTiers(root, lines){
  const host = root.querySelector('[data-tiers]');
  host.innerHTML = '';
  (lines || []).forEach(line => {
    const [l, r] = String(line||'').split('|').map(s => (s||'').trim());

    const row = document.createElement('div');
    row.className = 'tier-row';

    const left  = document.createElement('span');
    const right = document.createElement('span');

    left.textContent  = l;
    right.textContent = r;

    row.appendChild(left);
    row.appendChild(right);
    host.appendChild(row);
  });
}


  function renderVerified(root,on){ root.querySelector('[data-verified]').style.display = on ? 'inline-block' : 'none'; }
  function wireShare(root){ const b=root.querySelector('.share-btn'); if(!b) return; b.addEventListener('click',async e=>{ e.preventDefault(); const title=root.querySelector('.title')?.textContent?.trim()||'Project'; const url=location.href; if(navigator.share){ try{await navigator.share({title,url});}catch{} } else { await navigator.clipboard.writeText(url); b.title='Link copied'; setTimeout(()=>b.title='',1500); } }); }
  function wireTiers(root){ const btn=root.querySelector('.tier-link'),menu=root.querySelector('.tier-menu'); if(!btn||!menu) return; btn.addEventListener('click',e=>{ const open=menu.hasAttribute('hidden'); menu.toggleAttribute('hidden'); btn.setAttribute('aria-expanded',open?'true':'false'); e.preventDefault(); e.stopPropagation(); }); }

  function renderPagerInMedia(root){
  const host = root.querySelector('[data-pager]');
  if (!host) return;

  host.innerHTML = '';
  const total = Math.min(Array.isArray(panoList) ? panoList.length : 0, MAX_PANOS);
  if (total < 2){ host.style.display = 'none'; return; }
  host.style.display = 'flex';

  for (let i = 0; i < total; i++){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dot';
    btn.setAttribute('aria-label', `Show image ${i+1}`);
    if (i === activePanoIndex) btn.setAttribute('aria-current','true');

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      if (i === activePanoIndex) return;
      activePanoIndex = i;
      setPanoHiddenToActive();
      renderPreview();
    });

    host.appendChild(btn);
  }
}


  
  
  
  
  
  /* Построение карточки (ленивая инициализация панорамы) */
  const tpl = document.getElementById('card-tpl');
  function makeCard(data){
    const frag = tpl.content.cloneNode(true);
    const article=frag.querySelector('.card');
    article.setAttribute('aria-label', `${data.title1} — ${data.title2}`);

    fillTexts(frag, {
  ...data,
  raisedLabel: `${money(data.raised)} raised`,
  progressPct: `${data.progress}%`,
  raisedTotal: money(data.raised),
  daysLeft: `${data.daysLeft} days left`
});

// 👉 делаем заголовок кликабельным и ведём на страницу лота
const linkEl = frag.querySelector('[data-project-link]');
if (linkEl) {
  const url = titleToProductUrl(data.title1);   // https://ishare.ca/<slug>
  if (url) {
    linkEl.href = url;
    linkEl.setAttribute('aria-label', `Open ${data.title1}`);
  } else {
    linkEl.removeAttribute('href');
    linkEl.removeAttribute('aria-label');
  }
}



    renderChips(frag, data.chips);
    renderProgress(frag, data.progress||0, data.raised||0, data.monthsOnGraph||3);
    renderTiers(frag, data.tiers||[]);
    renderVerified(frag, !!data.verified);
    wireShare(frag); wireTiers(frag); renderPagerInMedia(frag);

    const pane   = frag.querySelector('[data-pano]');
    const loader = frag.querySelector('[data-loader]');
    const init = () => initPanoEl(pane, loader, getPanoCandidates(), {
    yaw:data.yaw, pitch:data.pitch, autoRotate:data.autoRotate, wheelZoom:data.wheelZoom
});

    return { node: frag, init };
  }

  /* Чипы из опций формы */
  const sectorTip = 'Choose the sector that resonates with your heart — this chip labels the project’s cause.';
  const taxTip    = 'Your donation is eligible for an official tax receipt (subject to local rules).';
  const matchTip  = (m)=>`For every $1 you give, our sponsor adds $${(parseFloat(m)-1).toFixed(1).replace(/\.0$/,'')}. Matching applies up to the campaign’s cap or deadline.`;

function buildChipsFromOptions(fd){
  const chips = [];
  const sector = fd.get('sector') || 'Health Care';
  chips.push(`${sector}::Choose the sector that resonates with your heart — this chip labels the project’s cause.`);

  if (fd.get('tax')) {
    chips.push(`Tax-deductible::Your donation is eligible for an official tax receipt (subject to local rules).`);
  }

  const m = fd.get('matching');
  if (m && m !== 'none') {
    const mult = parseFloat(m);
    const added = (mult - 1).toFixed(1).replace(/\.0$/, '');
    chips.push(`${m}× matching::For every $1 you give, our sponsor adds $${added}. Matching applies up to the campaign’s cap or deadline.`);

    if (fd.get('matchHelper')) {
      const add = mult - 1;
      const addText = Number.isInteger(add) ? add.toFixed(0) : (add.toFixed(1).replace(/\.0$/, ''));
      chips.push(`sponsor adds $${addText}::Sponsor adds this amount per $1 you give (until the campaign’s matching cap or deadline).`);
    }
  }

  // NEW: AI Agent chip
  if (fd.get('aiAgent')) {
    chips.push(`AI Agent · 24/7::Our always-on AI assistant is available around the clock to help donors.`);
  }

  return chips;
}


function readForm(form){
  const fd = new FormData(form);

  const num = (key, def = 0) => {
    const v = parseFloat(fd.get(key));
    return Number.isFinite(v) ? v : def;
  };
  const clamp = (n, min, max) => Math.min(Math.max(n, min), max);

  const tiers = (fd.get('tiers') || '')
    .split('\n').map(s => s.trim()).filter(Boolean);

  // safe parse for months (2..24)
  const monthsRaw = String(fd.get('raisedMonths') ?? '').trim();
  const monthsVal = parseInt(monthsRaw, 10);
  const months = clamp(Number.isFinite(monthsVal) ? monthsVal : 3, 2, 24);

  return {
    projectId: getOrCreateNumericId(),

    title1:    (fd.get('title1')    || '').trim(),
    title2:    (fd.get('title2')    || '').trim(),
    overlayH:  (fd.get('overlayH')  || '').trim(),
    overlaySub:(fd.get('overlaySub')|| '').trim(),

    panoSrc: fd.get('panoSrc') || DEFAULT_PANO,

    chips:     buildChipsFromOptions(fd),

    progress:  clamp(num('progress', 0), 0, 100),
    raised:    Math.max(0, num('raised', 0)),
    daysLeft:  Math.max(0, num('daysLeft', 0)),

    monthsOnGraph: months,
    raisedMonths:  months,

    naming:    (fd.get('naming')   || '').trim(),
    location:  (fd.get('location') || '').trim(),

    orgName:   (fd.get('orgName')  || '').trim(),
    orgUrl:    (fd.get('orgUrl')   || '#').trim(),

    verified:  !!fd.get('verified'),
    tiers,

    yaw:        num('yaw', 0),
    pitch:      num('pitch', 0),
    autoRotate: num('autoRotate', 1),
    wheelZoom:  !!fd.get('wheelZoom')
  };
}




let destroyCurrent = null;

  /* Live preview */
  const form = document.getElementById('card-form');
  const preview = document.getElementById('preview');
  
  
  
  
  function ensurePanoHiddenInput() {
  let el = form.querySelector('input[name="panoSrc"]');
  if (!el) {
    el = document.createElement('input');
    el.type = 'hidden';
    el.name = 'panoSrc';
    el.value = DEFAULT_PANO; // вместо хардкода './img/pano/panorama.jpg'
    form.appendChild(el);
  }
  return el; // важное — возвращаем элемент
}

ensurePanoHiddenInput();








  function renderPreview(){
  // 1) остановить и убрать прошлую сцену, если была
  setPanoHiddenToActive();

  if (typeof destroyCurrent === 'function') {
    try { destroyCurrent(); } catch(e) {}
    destroyCurrent = null;
  }

  // 2) собрать и вставить новую карточку
  preview.innerHTML = '';
  const built = makeCard( readForm(form) );
  preview.appendChild(built.node);

  // 3) инициализировать панораму и сохранить «очистку»
  const cleanup = built.init();   // initPanoEl возвращает функцию очистки
  if (typeof cleanup === 'function') {
    destroyCurrent = cleanup;
  }
  }

  form.addEventListener('input', renderPreview);
  form.addEventListener('change', renderPreview);
  renderPreview();

  /* Copy HTML */
  document.getElementById('copy-html').addEventListener('click', async ()=>{
    const card = preview.querySelector('.card');
    const html = card ? card.outerHTML : '';
    if(!html) return alert('Nothing to copy.');
    try{ await navigator.clipboard.writeText(html); alert('Card HTML copied.'); }
    catch{ const ta=document.createElement('textarea'); ta.value=html; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied.'); }
  });

  /* Save / Load */
  document.getElementById('save').addEventListener('click', ()=>{
    const data = readForm(form);
    localStorage.setItem('cardDraft', JSON.stringify(data));
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (data.title1||'card') + '.json';
    document.body.appendChild(a); a.click(); a.remove();
  });
  document.getElementById('load').addEventListener('click', ()=>{
    const raw = localStorage.getItem('cardDraft');
    if(!raw){ alert('No saved draft found.'); return; }
    const d = JSON.parse(raw);
    for (const [k,v] of Object.entries(d)){
      if (k in form.elements && typeof form.elements[k].value !== 'undefined' && typeof v !== 'object'){
        form.elements[k].value = v;
      }
    }
    form.elements.tax.checked = d.chips?.some(c=>String(c).startsWith('Tax-deductible'));
    const matchChip = (d.chips||[]).find(c=>/× matching/.test(c));
    form.elements.matching.value = matchChip ? matchChip.split('×')[0] : 'none';
    form.elements.matchHelper.checked = d.chips?.some(c=>String(c).startsWith('sponsor adds'));
    form.elements.verified.checked = !!d.verified;
    renderPreview();
  });

  /* Upload / Drag&Drop — FileReader → data:URL */
  const panoDrop = document.getElementById('panoDrop');
  const panoFile = document.getElementById('panoFile');
  const panoName = document.getElementById('panoFileName');

  
  
  // Список панорам (data URL или пути). Первый — «обложка».



function getPanoCandidates(){
  if (Array.isArray(panoList) && panoList.length){
    clampActive();
    const list = panoList.slice(0, MAX_PANOS);
    const cur  = list[activePanoIndex] ?? list[0];
    const rest = list.filter((_,i)=> i !== activePanoIndex);
    return [cur, ...rest]; // активный — первым
  }
  const single = form.querySelector('input[name="panoSrc"]')?.value || DEFAULT_PANO;
  return [single];
}






function renderPanoGallery(){
  const host = document.getElementById('panoGallery');
  if (!host) return;
  host.innerHTML = '';

  panoList.forEach((src, idx) => {
    const item = document.createElement('div');
    item.className = 'thumb' + (idx === activePanoIndex ? ' active' : '');
    item.innerHTML = `
      <img src="${src}">
      <button class="remove" title="Remove" aria-label="Remove this image">×</button>
      ${idx===activePanoIndex ? '<span class="badge">Active</span>' : ''}
    `;
    item.querySelector('.remove').addEventListener('click', (e) => {
  e.stopPropagation();
  panoList.splice(idx, 1);
  

  clampActive();
  setPanoHiddenToActive();
  renderPanoGallery();
  renderPreview();
});

    // клик по миниатюре — сделать её «обложкой» (переместить в начало)
    item.addEventListener('click', () => {
   if (idx !== activePanoIndex){
     activePanoIndex = idx;
     setPanoHiddenToActive();
     renderPanoGallery();
     renderPreview();
   }
 });
    host.appendChild(item);
  });

  // подпись с количеством
  const nameEl = document.getElementById('panoFileName');
  if (nameEl) nameEl.textContent = panoList.length ? `${panoList.length} image(s) in gallery` : '';
}
  
  
  
  
  // ДО: const MAX_PANOS = 12; let panoList = [];
function adoptFiles(fileList){
  const files = Array.from(fileList).filter(f =>
    (f.type && f.type.startsWith('image/')) ||
    /\.(jpe?g|png|webp)$/i.test(f.name || '')
  );
  if (!files.length){
    alert('Please choose JPG/PNG/WEBP image(s).');
    return;
  }

  // лимит галереи
  const room = Math.max(0, MAX_PANOS - panoList.length);
  const take = files.slice(0, room);
  if (take.length < files.length){
    alert(`Only ${room} more image(s) can be added (max ${MAX_PANOS}).`);
  }

  let done = 0;
  take.forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      panoList.push(reader.result);   // data:image/...
      done++;
      if (done === take.length){
        
        renderPanoGallery();          // перерисовать миниатюры
        renderPreview();              // перерисовать карточку
        const nameEl = document.getElementById('panoFileName');
        if (nameEl) nameEl.textContent = `${panoList.length} image(s) in gallery`;
      }
    };
    reader.readAsDataURL(file);
  });
}



  panoDrop.addEventListener('click', ()=> panoFile.click());
  panoDrop.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); panoFile.click(); } });
  panoDrop.querySelector('.dz-btn').addEventListener('click', e => {
  e.preventDefault();         // label и так откроет инпут
  e.stopPropagation();        // не отдаём клик наружу на panoDrop
});
  panoFile.addEventListener('change', () => {
  adoptFiles(panoFile.files);
  panoFile.value = ''; // сбросить, чтобы одно и то же можно выбрать снова
});
  panoDrop.addEventListener('dragover', e=>{ e.preventDefault(); panoDrop.classList.add('over'); });
  panoDrop.addEventListener('dragleave', ()=> panoDrop.classList.remove('over'));
  panoDrop.addEventListener('drop', e => {
  e.preventDefault();
  panoDrop.classList.remove('over');
  adoptFiles(e.dataTransfer.files);
});


/* ===== Launch campaign → сохранить карточку в каталог и открыть catalog.html ===== */

// slug из title1 (использует твою translitRU)
function titleToSlug(title){
  const latin = translitRU(String(title||''))
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();
  return latin.replace(/[^a-z0-9]+/g,'').slice(0,80) || 'project';
}

// ↓↓↓ замените существующий обработчик (или добавьте, если его нет)

document.getElementById('launch').addEventListener('click', async () => {
  // 1) Открываем вкладку СИНХРОННО и БЕЗ noopener/noreferrer — получаем живой хэндл
  const popup = window.open('about:blank', '_blank');
  if (popup) {
    try {
      popup.document.write('<!doctype html><title>Catalog</title><meta charset="utf-8"><p style="font:14px system-ui;padding:16px">Preparing campaign…</p>');
      popup.document.close();
    } catch {}
  }

  // 2) Собираем данные и пишем в localStorage (как у тебя)
  const item = readForm(form);
  item.projectId = mintUniqueId6();

  let prep;
  try { prep = await prepareGalleryForCatalog(); }
  catch { prep = { compact: [], idx: 0, cover: item.panoSrc || DEFAULT_PANO }; }

  item.panoList = prep.compact;
  item.activePanoIndex = prep.idx;
  item.panoSrc = prep.cover;

  const KEY = 'catalogItems';
  try {
    const arr = JSON.parse(localStorage.getItem(KEY) || '[]');
    arr.unshift(item);
    localStorage.setItem(KEY, JSON.stringify(arr));
  } catch (e) {
    try {
      item.panoList = [];
      const arr = JSON.parse(localStorage.getItem(KEY) || '[]');
      arr.unshift(item);
      localStorage.setItem(KEY, JSON.stringify(arr));
    } catch {
      // если совсем не удалось — закрываем пустую вкладку и выходим
      if (popup && !popup.closed) popup.close();
      alert('Не получилось сохранить в каталог (возможно, переполнен localStorage).');
      return;
    }
  }

  // 3) Перенаправляем ИМЕННО новую вкладку. Текущую страницу не трогаем
  if (popup && !popup.closed) {
    popup.location.href = 'catalog.html';
  } else {
    // запасной план: пробуем открыть через невидимую ссылку в новой вкладке
    const a = document.createElement('a');
    a.href = 'catalog.html';
    a.target = '_blank';
    a.rel = 'noopener';          // безопасность
    document.body.appendChild(a);
    a.click();
    a.remove();
    // текущую страницу НЕ перенаправляем
  }
});







</script>
</body>
</html>
